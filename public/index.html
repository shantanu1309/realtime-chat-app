<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Chat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #e5ddd5; }
        
        #sidebar { width: 240px; background: #075e54; color: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #user-list { list-style: none; padding: 0; }
        #user-list li { padding: 10px; margin-bottom: 5px; background: #128c7e; border-radius: 5px; font-size: 0.9em; }

        #chat-container { flex-grow: 1; display: flex; flex-direction: column; background-color: #efe7dd; }
        
        /* The container must be flex-column for align-self to work */
        #messages { 
            flex-grow: 1; 
            overflow-y: auto; 
            list-style-type: none; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        
        .msg { 
            padding: 8px 12px; 
            border-radius: 8px; 
            max-width: 70%; 
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* THE KEY CSS: My messages go right, Others go left */
        .my-message { 
            align-self: flex-end; 
            background: #dcf8c6; 
            border-bottom-right-radius: 2px;
        }
        
        .other-message { 
            align-self: flex-start; 
            background: white; 
            border-bottom-left-radius: 2px;
        }

        .msg strong { display: block; font-size: 0.75em; color: #075e54; margin-bottom: 2px; }
        .msg small { font-size: 0.65em; color: #888; margin-left: 10px; vertical-align: bottom; }

        #form { display: flex; padding: 15px; background: #f0f0f0; border-top: 1px solid #ccc; }
        #input { flex-grow: 1; padding: 12px; border: none; border-radius: 20px; outline: none; }
        button { background: #075e54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; margin-left: 10px; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>Online Users</h3>
        <ul id="user-list"></ul>
    </div>

    <div id="chat-container">
        <ul id="messages"></ul>
        <form id="form">
            <input id="input" autocomplete="off" placeholder="Type a message..." required />
            <button type="submit">➔</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const userName = prompt("What is your name?") || "User";
        const socket = io();

        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const userList = document.getElementById('user-list');

        // Identify self to server
        socket.emit('new user', userName);

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', {
                    user: userName,
                    text: input.value,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
                input.value = '';
            }
        });

        socket.on('chat message', (data) => {
            const item = document.createElement('li');
            
            // Compare the sender's ID to your current socket ID
            const isMe = data.senderId === socket.id;
            
            item.classList.add('msg');
            item.classList.add(isMe ? 'my-message' : 'other-message');

            item.innerHTML = `
                ${!isMe ? `<strong>${data.user}</strong>` : ''}
                <span>${data.text}</span>
                <small>${data.time}</small>
            `;
            
            messages.appendChild(item);
            messages.scrollTo(0, messages.scrollHeight);
        });

        socket.on('user list', (users) => {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `● ${user}`;
                userList.appendChild(li);
            });
        });
    </script>
</body>
</html>